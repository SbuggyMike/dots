<!-- SC_OFF --><div class="md"><p>I recently got a 2018 Elitebook 840 G5 (3RF07UT#ABA) from university surplus for a steal for a new arch machine. Initially, on install, things were great, but honestly I wasn&#39;t too concerned with USB ports or system peripherals; tracpad, keyboard, USB storage devices were functioning as expected.</p> <p>This is going to be lengthy, walking through what I&#39;ve tried.</p> <p>All hardware passed HP&#39;s UEFI diagnostics tool.</p> <p>Issue persists when booting to install media.</p> <h1>Bluetooth</h1> <table><thead> <tr> <th align="left">Network Controller</th> <th align="left">Notes</th> </tr> </thead><tbody> <tr> <td align="left">Intel 8265 / 8275</td> <td align="left">Should have bluetooth capability</td> </tr> </tbody></table> <p>This I was partially expected, bluetooth can be tough to get going.</p> <ul> <li>Steps i took:</li> </ul> <ol> <li>Installed <code>bluez, bluez-libs, bluez-utils-compat</code></li> <li>Enabled <code>btusb</code> module</li> <li>Enabled <code>bluetooth</code> service</li> </ol> <ul> <li>bluetoothctl output</li> </ul> <p>&#x200B;</p> <pre><code># bluetoothctl [bluetooth]# show No default controller available </code></pre> <ul> <li>rfkill output - No device!</li> </ul> <p>&#x200B;</p> <pre><code># rfkill ID TYPE DEVICE SOFT HARD 0 wlan phy0 unblocked unblocked </code></pre> <ul> <li>lspci output</li> </ul> <p>&#x200B;</p> <pre><code># lspci | grep &quot;8265 / 8275&quot; 01:00.0 Network controller: Intel Corporation Wireless 8265 / 8275 (rev 78) </code></pre> <ul> <li>dmesg</li> </ul> <p>&#x200B;</p> <pre><code># sudo dmesg | grep iwlwifi [ 3.283167] iwlwifi 0000:01:00.0: enabling device (0000 -&gt; 0002) [ 3.412466] iwlwifi 0000:01:00.0: loaded firmware version 36.ca7b901d.0 8265-36.ucode op_mode iwlmvm [ 3.846346] iwlwifi 0000:01:00.0: Detected Intel(R) Dual Band Wireless AC 8265, REV=0x230 [ 3.909163] iwlwifi 0000:01:00.0: base HW address: 74:70:fd:f2:79:70 [ 3.984849] iwlwifi 0000:01:00.0: iwlmvm doesn&#39;t allow to disable BT Coex, check bt_coex_active module parame ter [ 4.048051] iwlwifi 0000:01:00.0 wlp1s0: renamed from wlan0 # sudo dmesg | grep btusb usbcore: registered new interface driver btusb </code></pre> <p>Options in /etc/modprobe.d/iwlwifi.conf -&gt; <code>options iwlwifi bt_coex_active=0 11n_disable=8</code></p> <p>Note - Bluetooth adapter still not shown. In the specs for this laptop, 3RF07UT#ABA, bluetooth should exist. There is no setting for bluetooth in bios.</p> <ul> <li>Additional measures i tried from random forum posts</li> </ul> <ol> <li>HID2HCI</li> <li>Bios/Firmware update</li> <li>Downgraded kernel (tried 5.19, 5.16, 5.13, 5.11) with no changes</li> <li>several linux-firmware packages</li> </ol> <p>I suspect this network adapter may be faulty; but not certain.</p> <h1>USB issues</h1> <p>For some reason, I can only get the OS to successfully connect with the two kingston devices I have - a non-powered USB 3.0 hub, and a 64gb datatraveler flash drive. Flash drive works just fine plugged into the hub, as well.</p> <ul> <li>&#x200B;</li> </ul> <p>&#x200B;</p> <pre><code># sudo dmesg | grep usbcore [ 0.000000] Command line: BOOT_IMAGE=/vmlinuz-linux root=UUID=9c046902-77b5-4cba-a2f8-01ec91ceafae rw loglevel=3 quiet usbcore.autosuspend=-1 acpi_backlight=vendor audit_enabled=0 acpi.osi=Linux [ 0.066961] Kernel command line: BOOT_IMAGE=/vmlinuz-linux root=UUID=9c046902-77b5-4cba-a2f8-01ec91ceafae rw loglevel=3 quiet usbcore.autosuspend=-1 acpi_backlight=vendor audit_enabled=0 acpi.osi=Linux [ 0.539081] usbcore: registered new interface driver usbfs [ 0.539081] usbcore: registered new interface driver hub [ 0.539081] usbcore: registered new device driver usb [ 0.775553] usbcore: registered new interface driver usbserial_generic </code></pre> <p>Ignore the absence of btusb, module was disabled on this boot.</p> <pre><code># sudo dmesg | grep hci [ 0.770734] ahci 0000:00:17.0: version 3.0 [ 0.772040] ahci 0000:00:17.0: AHCI 0001.0301 32 slots 1 ports 6 Gbps 0x4 impl SATA mode [ 0.772047] ahci 0000:00:17.0: flags: 64bit ncq pm led clo only pio slum part deso sadm sds apst [ 0.774833] scsi host0: ahci [ 0.775164] scsi host1: ahci [ 0.775335] scsi host2: ahci [ 0.775446] ehci_hcd: USB 2.0 &#39;Enhanced&#39; Host Controller (EHCI) Driver [ 0.775476] ehci-pci: EHCI PCI platform driver [ 0.775494] ohci_hcd: USB 1.1 &#39;Open&#39; Host Controller (OHCI) Driver [ 0.775498] ohci-pci: OHCI PCI platform driver [ 0.775509] uhci_hcd: USB Universal Host Controller Interface driver [ 1.772787] xhci_hcd 0000:00:14.0: xHCI Host Controller [ 1.772801] xhci_hcd 0000:00:14.0: new USB bus registered, assigned bus number 1 [ 1.773915] xhci_hcd 0000:00:14.0: hcc params 0x200077c1 hci version 0x100 quirks 0x0000000081109810 [ 1.774603] usb usb1: Manufacturer: Linux 5.11.11-arch1-1 xhci-hcd [ 1.777094] xhci_hcd 0000:00:14.0: xHCI Host Controller [ 1.777104] xhci_hcd 0000:00:14.0: new USB bus registered, assigned bus number 2 [ 1.777111] xhci_hcd 0000:00:14.0: Host supports USB 3.0 SuperSpeed [ 1.777202] usb usb2: Manufacturer: Linux 5.11.11-arch1-1 xhci-hcd [ 1.779197] xhci_hcd 0000:3a:00.0: xHCI Host Controller [ 1.779205] xhci_hcd 0000:3a:00.0: new USB bus registered, assigned bus number 3 [ 1.780378] xhci_hcd 0000:3a:00.0: hcc params 0x200077c1 hci version 0x110 quirks 0x0000000200009810 [ 1.780650] usb usb3: Manufacturer: Linux 5.11.11-arch1-1 xhci-hcd [ 1.781933] xhci_hcd 0000:3a:00.0: xHCI Host Controller [ 1.781939] xhci_hcd 0000:3a:00.0: new USB bus registered, assigned bus number 4 [ 1.781943] xhci_hcd 0000:3a:00.0: Host supports USB 3.1 Enhanced SuperSpeed [ 1.782005] usb usb4: Manufacturer: Linux 5.11.11-arch1-1 xhci-hcd </code></pre> <p>Okay, nothing too interesting. As far as I am aware, usb usb1 is the internal devices, ie, webcam. usb usb2 is the usb3 ports on the device. usb3 and usb4 are responsible for thunderbolt / usb-c port.</p> <p>And here&#39;s where things get gross:</p> <pre><code># sudo dmesg | grep usb1 [ 1.774582] usb usb1: New USB device found, idVendor=1d6b, idProduct=0002, bcdDevice= 5.11 [ 1.774591] usb usb1: New USB device strings: Mfr=3, Product=2, SerialNumber=1 [ 1.774599] usb usb1: Product: xHCI Host Controller [ 1.774603] usb usb1: Manufacturer: Linux 5.11.11-arch1-1 xhci-hcd [ 1.774606] usb usb1: SerialNumber: 0000:00:14.0 [ 4.008893] usb usb1-port2: attempt power cycle [ 5.605617] usb usb1-port2: unable to enumerate USB device [ 6.688907] usb usb1-port9: Cannot enable. Maybe the USB cable is bad? [ 7.648906] usb usb1-port9: Cannot enable. Maybe the USB cable is bad? [ 7.648974] usb usb1-port9: attempt power cycle [ 8.855584] usb usb1-port9: Cannot enable. Maybe the USB cable is bad? [ 9.815574] usb usb1-port9: Cannot enable. Maybe the USB cable is bad? [ 9.815652] usb usb1-port9: unable to enumerate USB device </code></pre> <p>If kernel parameter <code>usbcore.autosuspend=-1</code> is not passed, this goes on for a very long time. I believe one of these devices is the webcam (port 9?) and I&#39;m not certain what the other one is.</p> <p>These messages also occur on hub usb2 when plugging in the other devices i&#39;ve tested: logitech wireless mouse, teensy 4.1 (I do have the drivers installed), my phone, simple HID devices (mice, keyboards). Only the kingston usb hub and flash drive work, which is odd. I have searched for rules, and there&#39;s nothing vendor specific. <code>/usr/share/hwdata/usb.ids</code> appears as expected.</p> <p>Again, everything is a-okay according to HP&#39;s UEFI hardware diagnostics. I&#39;m at a bit of a loss here.</p> <p>Below are the outputs of LSPCI and LSUSB in their entirety</p> <pre><code># lspci 00:00.0 Host bridge: Intel Corporation Xeon E3-1200 v6/7th Gen Core Processor Host Bridge/DRAM Registers (rev 08) 00:02.0 VGA compatible controller: Intel Corporation UHD Graphics 620 (rev 07) 00:14.0 USB controller: Intel Corporation Sunrise Point-LP USB 3.0 xHCI Controller (rev 21) 00:14.2 Signal processing controller: Intel Corporation Sunrise Point-LP Thermal subsystem (rev 21) 00:15.0 Signal processing controller: Intel Corporation Sunrise Point-LP Serial IO I2C Controller #0 (rev 21) 00:15.1 Signal processing controller: Intel Corporation Sunrise Point-LP Serial IO I2C Controller #1 (rev 21) 00:16.0 Communication controller: Intel Corporation Sunrise Point-LP CSME HECI #1 (rev 21) 00:17.0 SATA controller: Intel Corporation Sunrise Point-LP SATA Controller [AHCI mode] (rev 21) 00:1c.0 PCI bridge: Intel Corporation Sunrise Point-LP PCI Express Root Port #4 (rev f1) 00:1c.4 PCI bridge: Intel Corporation Sunrise Point-LP PCI Express Root Port #5 (rev f1) 00:1f.0 ISA bridge: Intel Corporation Sunrise Point LPC Controller/eSPI Controller (rev 21) 00:1f.2 Memory controller: Intel Corporation Sunrise Point-LP PMC (rev 21) 00:1f.3 Audio device: Intel Corporation Sunrise Point-LP HD Audio (rev 21) 00:1f.4 SMBus: Intel Corporation Sunrise Point-LP SMBus (rev 21) 00:1f.6 Ethernet controller: Intel Corporation Ethernet Connection (4) I219-V (rev 21) 01:00.0 Network controller: Intel Corporation Wireless 8265 / 8275 (rev 78) 02:00.0 PCI bridge: Intel Corporation JHL6340 Thunderbolt 3 Bridge (C step) [Alpine Ridge 2C 2016] (rev 02) 03:00.0 PCI bridge: Intel Corporation JHL6340 Thunderbolt 3 Bridge (C step) [Alpine Ridge 2C 2016] (rev 02) 03:01.0 PCI bridge: Intel Corporation JHL6340 Thunderbolt 3 Bridge (C step) [Alpine Ridge 2C 2016] (rev 02) 03:02.0 PCI bridge: Intel Corporation JHL6340 Thunderbolt 3 Bridge (C step) [Alpine Ridge 2C 2016] (rev 02) 04:00.0 System peripheral: Intel Corporation JHL6340 Thunderbolt 3 NHI (C step) [Alpine Ridge 2C 2016] (rev 02) 3a:00.0 USB controller: Intel Corporation JHL6340 Thunderbolt 3 USB 3.1 Controller (C step) [Alpine Ridge 2C 2016] (rev 02) </code></pre> <p>&#x200B;</p> <pre><code># lsusb -tv /: Bus 04.Port 1: Dev 1, Class=root_hub, Driver=xhci_hcd/2p, 10000M ID 1d6b:0003 Linux Foundation 3.0 root hub /: Bus 03.Port 1: Dev 1, Class=root_hub, Driver=xhci_hcd/2p, 480M ID 1d6b:0002 Linux Foundation 2.0 root hub /: Bus 02.Port 1: Dev 1, Class=root_hub, Driver=xhci_hcd/6p, 5000M ID 1d6b:0003 Linux Foundation 3.0 root hub /: Bus 01.Port 1: Dev 1, Class=root_hub, Driver=xhci_hcd/12p, 480M ID 1d6b:0002 Linux Foundation 2.0 root hub </code></pre> <p>I&#39;m at a bit of a loss here... any advice or further actions would be a great help. otherwise, I&#39;ll just find a way to live without, lol.</p> <p>&#x200B;</p> <p>I do recall at one point - webcam DID show up in lsusb. I have also tried physically disconnecting devices, like the card reader and fingerprint scanner, from the motherboard. zero change in output.</p> </div><!-- SC_ON --> &#32; submitted by &#32; <a href="https://www.reddit.com/user/grapefruit7"> /u/grapefruit7 </a> <br/> <span><a href="https://www.reddit.com/r/archlinux/comments/wh26ef/newtome_hp_laptop_majority_of_devices_not_working/">[link]</a></span> &#32; <span><a href="https://www.reddit.com/r/archlinux/comments/wh26ef/newtome_hp_laptop_majority_of_devices_not_working/">[comments]</a></span>