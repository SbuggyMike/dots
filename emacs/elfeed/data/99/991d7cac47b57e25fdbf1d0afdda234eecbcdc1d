<p>I was going through my git commit history in my public <a href="https://github.com/andreyorst/dotfiles" target="_blank">dotfiles repository</a>, and noticed that prior to using <a href="https://github.com/radian-software/straight.el" target="_blank">straight.el</a> I’ve, like many, used inbuilt solution for managing packages, called <code>package.el</code>.
However, there was one thing that bothered me, and was one of the reasons that made me think about switching to <code>straight</code> was the fact, that a lot of times when I wanted to update or install packages, I couldn’t, due to an outdated package cache.
So I’ve fixed this, but since I’ve moved to straight I no longer needed this piece of code, and hence I’ve deleted it.
But it might be useful for people who use <code>package.el</code>, so I’ve decided to share it here.</p>
<p>First thing needed is a custom variable to store the last refresh date.
I’ve chosen Custom because it is persisted on disk, which allows me to use <code>customize-save-variable</code> later to make the value persist across sessions, and be easily reset via the customization interface:</p>
<div class="highlight"><pre tabindex="0"><code class="language-emacs-lisp"><span style="display: flex;"><span>(<span style="font-weight: bold; font-style: italic;">defcustom</span> <span style="color: #666; font-weight: bold; font-style: italic;">package-last-refresh-date</span> <span style="color: #666; font-weight: bold; font-style: italic;">nil</span>
</span></span><span style="display: flex;"><span>  <span style="color: #666; font-style: italic;">"Date and time when package lists have been refreshed.
</span></span></span><span style="display: flex;"><span><span style="color: #666; font-style: italic;">
</span></span></span><span style="display: flex;"><span><span style="color: #666; font-style: italic;">  This variable is then used to check whether
</span></span></span><span style="display: flex;"><span><span style="color: #666; font-style: italic;">  </span><span style="color: #666; font-style: italic;">`package-refresh-contents'</span><span style="color: #666; font-style: italic;"> call is needed before calling
</span></span></span><span style="display: flex;"><span><span style="color: #666; font-style: italic;">  </span><span style="color: #666; font-style: italic;">`package-install'</span><span style="color: #666; font-style: italic;">. Value of this varialbe is updated when
</span></span></span><span style="display: flex;"><span><span style="color: #666; font-style: italic;">  </span><span style="color: #666; font-style: italic;">`package-refresh-contents'</span><span style="color: #666; font-style: italic;"> is called.
</span></span></span><span style="display: flex;"><span><span style="color: #666; font-style: italic;">
</span></span></span><span style="display: flex;"><span><span style="color: #666; font-style: italic;">  See </span><span style="color: #666; font-style: italic;">`package-refresh-hour-threshold'</span><span style="color: #666; font-style: italic;"> for amount of time needed to
</span></span></span><span style="display: flex;"><span><span style="color: #666; font-style: italic;">  trigger refresh."</span>
</span></span><span style="display: flex;"><span>  <span style="font-weight: bold; font-style: italic;">:type</span> <span style="color: #666; font-style: italic;">'string</span>
</span></span><span style="display: flex;"><span>  <span style="font-weight: bold; font-style: italic;">:group</span> <span style="color: #666; font-style: italic;">'package</span>)
</span></span></code></pre></div><p>This variable is useful on its own, but we also need another one, that will specify how much time needs to pass since the last refresh to trigger package refreshing again.
I’ve chosen to store amount of hours, since you don’t need to refresh contents really often, but it may be a personal preference.
For example, if you update or install packages once a week, it doesn’t really matter, but if you, like me often tried cool packages that people share over the internet, the refresh rate may be set a bit lower than that.</p>
<div class="highlight"><pre tabindex="0"><code class="language-emacs-lisp"><span style="display: flex;"><span>(<span style="font-weight: bold; font-style: italic;">defcustom</span> <span style="color: #666; font-weight: bold; font-style: italic;">package-automatic-refresh-threshold</span> 24
</span></span><span style="display: flex;"><span>  <span style="color: #666; font-style: italic;">"Amount of hours since last </span><span style="color: #666; font-style: italic;">`package-refresh-contents'</span><span style="color: #666; font-style: italic;"> call
</span></span></span><span style="display: flex;"><span><span style="color: #666; font-style: italic;">  needed to trigger automatic refresh before calling </span><span style="color: #666; font-style: italic;">`package-install'</span><span style="color: #666; font-style: italic;">."</span>
</span></span><span style="display: flex;"><span>  <span style="font-weight: bold; font-style: italic;">:type</span> <span style="color: #666; font-style: italic;">'number</span>
</span></span><span style="display: flex;"><span>  <span style="font-weight: bold; font-style: italic;">:group</span> <span style="color: #666; font-style: italic;">'package</span>)
</span></span></code></pre></div><p>With these two helper variables we can start “patching” <code>package.el</code> so it would use it.
We don’t need to modify code, thanks to advanced advice system:</p>
<div class="highlight"><pre tabindex="0"><code class="language-emacs-lisp"><span style="display: flex;"><span>(<span style="font-weight: bold; font-style: italic;">define-advice</span> <span style="color: #666; font-weight: bold; font-style: italic;">package-install</span> (<span style="font-weight: bold; font-style: italic;">:before</span> (<span style="font-weight: bold;">&amp;rest</span> <span style="color: #666; font-weight: bold; font-style: italic;">_</span>) <span style="color: #666; font-weight: bold; font-style: italic;">package-refresh-contents-maybe</span>)
</span></span><span style="display: flex;"><span>  (<span style="font-weight: bold; font-style: italic;">when</span> (<span style="font-weight: bold; font-style: italic;">or</span> (<span style="color: #666; font-weight: bold; font-style: italic;">null</span> <span style="color: #666; font-weight: bold; font-style: italic;">package-last-refresh-date</span>)
</span></span><span style="display: flex;"><span>            (<span style="color: #666; font-weight: bold; font-style: italic;">&gt;</span> (<span style="color: #666; font-weight: bold; font-style: italic;">/</span> (<span style="color: #666; font-weight: bold; font-style: italic;">float-time</span>
</span></span><span style="display: flex;"><span>                   (<span style="color: #666; font-weight: bold; font-style: italic;">time-subtract</span> (<span style="color: #666; font-weight: bold; font-style: italic;">date-to-time</span> (<span style="color: #666; font-weight: bold; font-style: italic;">format-time-string</span> <span style="color: #666; font-style: italic;">"%Y-%m-%dT%H:%M"</span>))
</span></span><span style="display: flex;"><span>                                  (<span style="color: #666; font-weight: bold; font-style: italic;">date-to-time</span> <span style="color: #666; font-weight: bold; font-style: italic;">package-last-refresh-date</span>)))
</span></span><span style="display: flex;"><span>                  3600)
</span></span><span style="display: flex;"><span>               <span style="color: #666; font-weight: bold; font-style: italic;">package-automatic-refresh-threshold</span>))
</span></span><span style="display: flex;"><span>    (<span style="color: #666; font-weight: bold; font-style: italic;">package-refresh-contents</span>)))
</span></span><span style="display: flex;"><span>
</span></span><span style="display: flex;"><span>(<span style="font-weight: bold; font-style: italic;">define-advice</span> <span style="color: #666; font-weight: bold; font-style: italic;">package-refresh-contents</span> (<span style="font-weight: bold; font-style: italic;">:after</span> (<span style="font-weight: bold;">&amp;rest</span> <span style="color: #666; font-weight: bold; font-style: italic;">_</span>) <span style="color: #666; font-weight: bold; font-style: italic;">update-package-refresh-date</span>)
</span></span><span style="display: flex;"><span>  (<span style="color: #666; font-weight: bold; font-style: italic;">customize-save-variable</span> <span style="color: #666; font-style: italic;">'package-last-refresh-date</span>
</span></span><span style="display: flex;"><span>                           (<span style="color: #666; font-weight: bold; font-style: italic;">format-time-string</span> <span style="color: #666; font-style: italic;">"%Y-%m-%dT%H:%M"</span>)))
</span></span></code></pre></div><p>The first advice ensure that before installing a package we’ll refresh package contents, if enough time has passed since the last refresh, that is.
The second one simply updates the last refresh time, and stores it in the custom file, which I, personally, changed to <code>custom.el</code> in my Emacs directory, like this:</p>
<div class="highlight"><pre tabindex="0"><code class="language-emacs-lisp"><span style="display: flex;"><span>(<span style="font-weight: bold; font-style: italic;">use-package</span> <span style="color: #666; font-weight: bold; font-style: italic;">cus-edit</span>
</span></span><span style="display: flex;"><span>  <span style="font-weight: bold; font-style: italic;">:custom</span> (<span style="color: #666; font-weight: bold; font-style: italic;">custom-file</span> (<span style="color: #666; font-weight: bold; font-style: italic;">expand-file-name</span> <span style="color: #666; font-style: italic;">"custom.el"</span> <span style="color: #666; font-weight: bold; font-style: italic;">user-emacs-directory</span>))
</span></span><span style="display: flex;"><span>  <span style="font-weight: bold; font-style: italic;">:init</span> (<span style="color: #666; font-weight: bold; font-style: italic;">load</span> <span style="color: #666; font-weight: bold; font-style: italic;">custom-file</span> <span style="font-weight: bold; font-style: italic;">:noerror</span>))
</span></span></code></pre></div><p>This file is not a part of my version control system, and hosts a lot of machine local configuration, so it was natural to store last refresh date in it too.
Of course, it is possible to store it in an arbitrary file, since it’s just a string, and read it inside the <code>package-install</code> advice, but customize makes it seamless, and worked for me quite well.</p>
<p>Hope this was a useful tip!</p>